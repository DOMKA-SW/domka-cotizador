<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <title>DOMKA - Cotizaci√≥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PDFMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-6">

  <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-6 md:p-8 mx-2">

    <!-- Encabezado -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-lg shadow-md mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Cotizaci√≥n</h1>
        <p class="text-sm">DOMKA | Alex Otalora</p>
      </div>
      <img src="../img/logo.png" alt="DOMKA Logo" class="h-12">
    </div>

    <!-- Contenedor cotizaci√≥n -->
    <div id="cotizacion" class="text-gray-800">
      <p>Cargando cotizaci√≥n...</p>
    </div>

    <!-- Estado -->
    <div id="estado-cotizacion" class="mt-4 text-center"></div>

    <!-- Bot√≥n de descarga PDF -->
    <div class="text-center mt-4">
      <button id="descargar-pdf-publico"
        class="inline-flex items-center justify-center gap-2 bg-orange-600 text-white px-5 py-2 rounded-lg hover:bg-orange-700 shadow">
        üì• Descargar PDF
      </button>
    </div>

    <!-- üîπ Bot√≥n CONFIRMAR RECIBIDO (reemplaza toda la firma) -->
    <div id="acciones" class="hidden mt-6 text-center">
      <p class="text-gray-600 text-sm mb-3">¬øRecibiste esta cotizaci√≥n? Conf√≠rmalo con un clic.</p>
      <button id="btn-confirmar-recibido"
        class="inline-flex items-center gap-2 bg-green-600 text-white px-8 py-3 rounded-lg shadow hover:bg-green-700 text-lg font-semibold transition-all">
        ‚úÖ Confirmar Recibido
      </button>
    </div>

    <!-- Confirmaci√≥n exitosa -->
    <div id="confirmacion-recibido" class="hidden mt-6 text-center p-4 bg-green-50 border border-green-200 rounded-lg">
      <p class="text-green-700 font-semibold text-lg">‚úÖ ¬°Recibido confirmado!</p>
      <p class="text-sm text-gray-600 mt-1">Hemos registrado tu confirmaci√≥n correctamente.</p>
    </div>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
      <p>DOMKA 2025</p>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script src="../js/firebase.js"></script>
  <script src="../js/numero-letras.js"></script>
  <script src="../js/pdf-cotizacion.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cotizacion");
    const acciones = document.getElementById("acciones");
    const estadoDiv = document.getElementById("estado-cotizacion");
    const btnDescargaPublico = document.getElementById("descargar-pdf-publico");
    const btnConfirmar = document.getElementById("btn-confirmar-recibido");
    const confirmacionRecibido = document.getElementById("confirmacion-recibido");

    let cotizacionRef, cotizacionData;

    // ============================
    // üîπ Helpers de formato
    // ============================
    function traducirTipo(tipo) {
      switch(tipo) {
        case "mano-obra": return "Mano de obra";
        case "materiales": return "Materiales";
        case "ambos": return "Mano de obra y materiales";
        default: return tipo || "No especificado";
      }
    }

    function formatearFormaPago(formaPago, planPagos) {
      switch(formaPago) {
        case "contado": return "Pago al contado";
        case "60-40": return "60% al inicio - 40% al finalizar";
        case "50-50": return "50% al inicio - 50% al finalizar";
        case "tres-pagos": return "Tres pagos (40%-30%-30%)";
        case "personalizado": return (planPagos || []).map(p => `${p.porcentaje}% ${p.descripcion}`).join(", ");
        default: return formaPago;
      }
    }

    function ocultarColumnasValorTotal() {
      const tabla = document.getElementById("tabla-cotizacion-detalle");
      if (!tabla) return;
      tabla.querySelectorAll("th")[1].classList.add("hidden");
      tabla.querySelectorAll("th")[2].classList.add("hidden");
      tabla.querySelectorAll("th")[3].classList.add("hidden");
      tabla.querySelectorAll("td").forEach(celda => {
        if (celda.classList.contains("col-cantidad") || celda.classList.contains("col-precio") || celda.classList.contains("col-subtotal"))
          celda.classList.add("hidden");
      });
    }

    // ============================
    // üîπ Cargar cotizaci√≥n
    // ============================
    async function cargarCotizacion() {
      if (!id) { container.innerHTML = "<p class='text-red-600'>Error: No se especific√≥ ID</p>"; return; }
      cotizacionRef = db.collection("cotizaciones").doc(id);
      const doc = await cotizacionRef.get();
      if (!doc.exists) { container.innerHTML = "<p class='text-red-600'>No encontrada</p>"; return; }

      cotizacionData = doc.data();
      const c = cotizacionData;
      const fecha = c.fecha ? new Date(c.fecha.seconds ? c.fecha.seconds * 1000 : c.fecha) : new Date();
      const valorEnLetras = (typeof numeroAPalabras === "function") ? numeroAPalabras(c.total || 0) : "";

      // üîπ Notas: si hay array de vi√±etas, renderizarlas como lista
      let notasHTML = "";
      const vi√±etas = c.notasArray && c.notasArray.length > 0
        ? c.notasArray
        : (c.notas ? c.notas.split("\n").filter(l => l.trim()) : []);

      if (vi√±etas.length > 1) {
        notasHTML = `<ul class="list-disc list-inside space-y-1 text-sm text-gray-800">
          ${vi√±etas.map(v => `<li>${v}</li>`).join("")}
        </ul>`;
      } else if (c.notas) {
        notasHTML = `<p class="text-sm text-gray-800">${c.notas}</p>`;
      }

      container.innerHTML = `
        <!-- Datos principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
            <p class="text-sm text-gray-500">Nombre/Empresa</p>
            <p class="font-semibold text-gray-800">${c.nombreCliente || "‚Äî"}</p>
          </div>
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
            <p class="text-sm text-gray-500">Fecha</p>
            <p class="font-semibold text-gray-800">${fecha.toLocaleDateString("es-CO")}</p>
          </div>
          ${c.ubicacion ? `<div class="p-4 bg-gray-50 border rounded-lg shadow-sm"><p class="text-sm text-gray-500">Ubicaci√≥n</p><p class="font-semibold text-gray-800">${c.ubicacion}</p></div>` : ""}
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
            <p class="text-sm text-gray-500">Forma de pago</p>
            <p class="font-semibold text-gray-800">${formatearFormaPago(c.formaPago, c.planPagos || [])}</p>
          </div>
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
            <p class="text-sm text-gray-500">Tipo</p>
            <p class="font-semibold text-gray-800">${traducirTipo(c.tipo)}</p>
          </div>
          ${c.mostrarDocumento !== false && c.clienteNit ? `
            <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
              <p class="text-sm text-gray-500">NIT</p>
              <p class="font-semibold text-gray-800">${c.clienteNit}</p>
            </div>` : ""}
          ${c.mostrarDocumento !== false && c.clienteNumeroDocumento ? `
            <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
              <p class="text-sm text-gray-500">N¬∞ Documento</p>
              <p class="font-semibold text-gray-800">${c.clienteNumeroDocumento}</p>
            </div>` : ""}
        </div>

        <!-- Tabla -->
        <h2 class="text-lg font-semibold border-b pb-2 mb-4">Detalle de la cotizaci√≥n</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left border rounded-lg overflow-hidden shadow-md" id="tabla-cotizacion-detalle">
            <thead class="bg-orange-600 text-white text-sm uppercase">
              <tr>
                <th class="px-4 py-2">Descripci√≥n</th>
                <th class="px-4 py-2 text-center col-cantidad">Cantidad</th>
                <th class="px-4 py-2 text-right col-precio">Precio</th>
                <th class="px-4 py-2 text-right col-subtotal">Subtotal</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
              ${(c.items || []).map(item => `
                <tr>
                  <td class="px-4 py-2">${item.descripcion || ""}</td>
                  <td class="px-4 py-2 text-center col-cantidad">${item.cantidad || 0}</td>
                  <td class="px-4 py-2 text-right col-precio">$${Number(item.precio || 0).toLocaleString("es-CO")}</td>
                  <td class="px-4 py-2 text-right col-subtotal">$${Number(item.subtotal || 0).toLocaleString("es-CO")}</td>
                </tr>`).join("")}
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg shadow-sm text-right mt-4">
          <p class="text-gray-700">Subtotal: <span class="font-semibold">$${Number(c.subtotal || 0).toLocaleString("es-CO")}</span></p>
          <p class="text-xl font-bold text-orange-700">Total: $${Number(c.total || 0).toLocaleString("es-CO")}</p>
          ${c.mostrarValorLetras ? `<p class="text-sm italic mt-1 text-gray-600">Son: ${valorEnLetras}</p>` : ""}
        </div>

        <!-- Notas -->
        ${notasHTML ? `<div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg shadow-sm mt-4">${notasHTML}</div>` : ""}

        <!-- Anexos -->
        ${(c.anexos && c.anexos.length) ? `
          <div class="mt-6 border rounded-lg overflow-hidden">
            <button onclick="this.nextElementSibling.classList.toggle('hidden')"
              class="w-full px-4 py-3 bg-gray-100 font-semibold flex justify-between items-center">
              üìé Anexos (${c.anexos.length})
              <span>‚ñº</span>
            </button>
            <div class="p-4 space-y-6 hidden">
              ${c.anexos.map(a => {
                if (a.tipo === "application/pdf") {
                  return `<div class="border rounded p-3">
                    <div class="flex justify-between items-center mb-2">
                      <p class="font-semibold">üìÑ ${a.nombre}</p>
                      <a href="${a.base64}" download="${a.nombre}" class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                    </div>
                    <iframe src="${a.base64}" class="w-full h-[500px] border rounded"></iframe>
                  </div>`;
                }
                if (a.tipo && a.tipo.startsWith("image/")) {
                  return `<div class="border rounded p-3">
                    <div class="flex justify-between items-center mb-2">
                      <p class="font-semibold">üñºÔ∏è ${a.nombre}</p>
                      <a href="${a.base64}" download="${a.nombre}" class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                    </div>
                    <img src="${a.base64}" alt="${a.nombre}" class="max-w-full rounded border"/>
                  </div>`;
                }
                return `<div class="border rounded p-3 flex justify-between items-center">
                  <p class="font-semibold">üìé ${a.nombre}</p>
                  <a href="${a.base64}" download="${a.nombre}" class="bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                </div>`;
              }).join("")}
            </div>
          </div>` : ""}
      `;

      if (c.tipoCalculo === "valor-total") { setTimeout(ocultarColumnasValorTotal, 100); }

      // Estado
      if (!c.estado || c.estado === "pendiente") {
        estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-700">‚è≥ Pendiente</span>`;
        acciones.classList.remove("hidden");
      } else if (c.estado === "aprobada") {
        estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">‚úÖ Recibido confirmado</span>`;
      } else if (c.estado === "rechazada") {
        estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700">‚ùå Rechazada</span>`;
      }

      btnDescargaPublico.onclick = () => generarPDFCotizacion({ ...c, id }, c.nombreCliente);
    }

    // ============================
    // üîπ Confirmar Recibido ‚Äî solo log, sin firma
    // ============================
    btnConfirmar.addEventListener("click", async () => {
      btnConfirmar.disabled = true;
      btnConfirmar.textContent = "Guardando...";

      try {
        // Actualizar estado en Firestore
        await cotizacionRef.update({
          estado: "aprobada",
          fechaRecibido: firebase.firestore.FieldValue.serverTimestamp()
        });

        // üîπ Guardar log
        await db.collection("logs").add({
          docId: id,
          tipo: "cotizacion",
          accion: "recibido_confirmado",
          nombreCliente: cotizacionData?.nombreCliente || "",
          total: cotizacionData?.total || 0,
          userAgent: navigator.userAgent || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        acciones.classList.add("hidden");
        confirmacionRecibido.classList.remove("hidden");
        estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">‚úÖ Recibido confirmado</span>`;
      } catch (e) {
        console.error("Error al confirmar:", e);
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = "‚úÖ Confirmar Recibido";
        alert("Error al confirmar. Por favor intenta de nuevo.");
      }
    });

    // ============================
    // üîπ Tracking de visitas
    // ============================
    (function() {
      async function fetchIpInfo() {
        try {
          const resp = await fetch("https://ipapi.co/json/");
          if (!resp.ok) throw new Error("ip lookup failed");
          return await resp.json();
        } catch (e) {
          return {};
        }
      }

      async function logView() {
        const ipInfo = await fetchIpInfo();
        try {
          await db.collection("logs").add({
            docId: id,
            tipo: "cotizacion",
            accion: "vista",
            userAgent: navigator.userAgent || null,
            referer: document.referrer || null,
            ip: ipInfo.ip || null,
            city: ipInfo.city || null,
            country: ipInfo.country_name || null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (err) {
          console.warn("Error guardando log:", err);
        }
      }

      window.addEventListener("load", logView);
    })();

    document.addEventListener("DOMContentLoaded", cargarCotizacion);
  </script>
</body>
</html>
