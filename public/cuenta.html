<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <title>DOMKA - Cuenta de Cobro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    .hidden { display: none; }
    .signature-pad { border: 1px solid #e5e7eb; border-radius: 0.375rem; background: #f9fafb; }
    /* Estilos para el modal */
    #modal-recomendacion {
      transition: all 0.3s ease-in-out;
    }
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-6">

  <!-- Modal de Recomendaci√≥n -->
  <div id="modal-recomendacion" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-auto transform transition-all">
        <!-- Header - con los mismos colores gradient -->
        <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-t-xl">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl font-bold">¬°Firme su recibido!</h3>
              <p class="text-orange-100 text-sm mt-1">Obtenga su copia oficial con firma</p>
            </div>
            <div class="bg-white bg-opacity-20 p-2 rounded-full">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Contenido -->
        <div class="p-6">
          <div class="space-y-4">
            <div class="flex items-start space-x-3">
              <div class="bg-green-100 p-2 rounded-full mt-1">
                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-800">Confirmaci√≥n oficial</p>
                <p class="text-sm text-gray-600">Su firma confirma que recibi√≥ la cuenta de cobro</p>
              </div>
            </div>
            
            <div class="flex items-start space-x-3">
              <div class="bg-blue-100 p-2 rounded-full mt-1">
                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-800">PDF con su firma</p>
                <p class="text-sm text-gray-600">Descargue la versi√≥n PDF que incluye su firma digital</p>
              </div>
            </div>
            
            <div class="flex items-start space-x-3">
              <div class="bg-purple-100 p-2 rounded-full mt-1">
                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
              </div>
              <div>
                <p class="font-semibold text-gray-800">Proceso seguro</p>
                <p class="text-sm text-gray-600">Su firma se almacena de forma segura en nuestros registros</p>
              </div>
            </div>
          </div>
          
          <!-- Barra de progreso visual -->
          <div class="mt-6 bg-gray-200 rounded-full h-2">
            <div class="bg-orange-600 h-2 rounded-full w-3/4"></div>
          </div>
          <p class="text-xs text-gray-500 text-center mt-2">Complete el proceso de confirmaci√≥n</p>
        </div>
        
        <!-- Footer del Modal -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-between items-center">
          <button id="btn-cerrar-modal" class="text-gray-600 hover:text-gray-800 text-sm font-medium">
            Cerrar
          </button>
          <button id="btn-empezar-firma" class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 font-medium flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
            </svg>
            Empezar a firmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-6 md:p-8 mx-2">

    <!-- üîπ Encabezado -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-lg shadow-md mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Cuenta de Cobro</h1>
        <p class="text-sm">DOMKA | Alex Otalora</p>
      </div>
      <img src="../img/logo.png" alt="DOMKA Logo" class="h-12">
    </div>

    <!-- üîπ Contenido -->
    <div id="cuenta" class="text-gray-800">
      <p>Cargando cuenta de cobro...</p>
    </div>

    <!-- üîπ Firma digital -->
    <div id="firma-container" class="hidden mt-6">
      <h3 class="font-semibold mb-2">Firma de conformidad</h3>
      <p class="text-sm text-gray-600 mb-3">Por favor, firme en el recuadro para confirmar la recepci√≥n</p>
      <canvas id="firma-pad" class="signature-pad w-full" width="500" height="200"></canvas>
      <div class="flex justify-between mt-2">
        <button id="limpiar-firma" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border rounded">Limpiar</button>
        <button id="guardar-firma" class="bg-orange-600 text-white px-4 py-1 rounded text-sm hover:bg-orange-700">Guardar firma</button>
      </div>
    </div>

    <!-- üîπ Botones acci√≥n -->
    <div id="acciones" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-6">
      <button id="confirmar" class="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 mb-2 sm:mb-0">‚úÖ Confirmar Recepci√≥n</button>
      <button id="descargar-pdf" class="flex items-center gap-2 bg-orange-600 text-white px-6 py-2 rounded-lg shadow hover:bg-orange-700">üìÑ Descargar PDF</button>
    </div>

    <!-- üîπ Confirmaci√≥n -->
    <div id="confirmacion-firma" class="hidden mt-6 text-center">
      <p class="text-green-600 font-semibold">‚úÖ Cuenta de cobro confirmada con firma digital</p>
      <p class="text-sm text-gray-600 mt-2">Hemos registrado su confirmaci√≥n correctamente.</p>
      <div id="firma-guardada" class="mt-4 mx-auto max-w-xs"></div>
    </div>

    <!-- üîπ Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
      <p>DOMKA 2025 - Alex Otalora</p>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="../js/firebase.js"></script>
  <script src="../js/numero-letras.js"></script>
  <script src="../js/pdf-cuenta.js"></script>
  <script>
    
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cuenta");
    const acciones = document.getElementById("acciones");
    const firmaContainer = document.getElementById("firma-container");
    const confirmacionFirma = document.getElementById("confirmacion-firma");
    const descargarPdfBtn = document.getElementById("descargar-pdf");

    // Variables para el modal
    const modalRecomendacion = document.getElementById("modal-recomendacion");
    const btnCerrarModal = document.getElementById("btn-cerrar-modal");
    const btnEmpezarFirma = document.getElementById("btn-empezar-firma");

    let cuentaRef;
    let signaturePad;
    let cuentaData = null;

    // Funci√≥n para mostrar el modal autom√°ticamente
    function mostrarModalRecomendacion() {
      setTimeout(() => {
        modalRecomendacion.classList.remove('hidden');
        try {
          db.collection("logs").add({
            docId: id,
            event: "modal_recomendacion_mostrado",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (e) { console.warn("Error en analytics modal:", e); }
      }, 1000);
    }

    function ocultarModalRecomendacion() {
      modalRecomendacion.classList.add('hidden');
    }

    // Inicializar el pad de firma
    function inicializarFirma() {
      const canvas = document.getElementById("firma-pad");
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1.5,
        maxWidth: 2.5,
        throttle: 16,
      });

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      document.getElementById("limpiar-firma").addEventListener("click", () => {
        signaturePad.clear();
      });

      document.getElementById("guardar-firma").addEventListener("click", () => {
        if (signaturePad.isEmpty()) {
          alert("Por favor, proporcione su firma primero");
          return;
        }

        const firmaData = signaturePad.toDataURL();
        guardarConfirmacionConFirma(firmaData);
      });
    }

    // Cargar cuenta de cobro
    async function cargarCuenta() {
      if (!id) {
        container.innerHTML = "<p class='text-red-600'>Error: No se especific√≥ ID de cuenta de cobro</p>";
        return;
      }

      try {
        cuentaRef = db.collection("cuentas").doc(id);
        const doc = await cuentaRef.get();
        
        if (!doc.exists) {
          container.innerHTML = "<p class='text-red-600'>Error: Cuenta de cobro no encontrada</p>";
          return;
        }

        cuentaData = doc.data();
        cuentaData.id = id; // Asegurar que el ID est√© incluido
        const c = cuentaData;
        const fecha = c.fecha ? new Date(c.fecha.seconds ? c.fecha.seconds * 1000 : c.fecha) : new Date();
        
        const valorEnLetras = (typeof numeroAPalabras === 'function') ? 
          numeroAPalabras(c.total || 0) : 
          `$${Number(c.total || 0).toLocaleString("es-CO")}`;
        
        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <p class="font-semibold">Nombre/Empresa:</p>
              <p>${c.nombreCliente || "No especificado"}</p>
              <p class="text-sm text-gray-600 mt-1">ID: ${id}</p>
            </div>
            <div class="md:text-right">
              <p class="font-semibold">Fecha:</p>
              <p>${fecha.toLocaleDateString('es-CO')}</p>
              <span class="inline-block mt-2 px-2 py-1 rounded text-xs ${c.estado === "pagada" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}">
                ${c.estado || "pendiente"}
              </span>
            </div>
          </div>

            <!-- üîπ Aqu√≠ agregamos el bloque de "Debe a" y "Por concepto de" -->
          <div class="mb-6">
           <p class="font-semibold">Debe a:</p>
           <p>Alexander Otalora Camayo</p>

           <p class="font-semibold mt-2">Por concepto de:</p>
           <p>${c.concepto || "-"}</p>
          </div>

          <h2 class="text-lg font-semibold border-b pb-2 mb-4">Descripci√≥n del Servicio</h2>
          <div class="mb-6">
            ${(c.items || []).map(item => `
              <div class="border-b py-2">
                <p>${item.descripcion || ""}</p>
              </div>
            `).join("")}
          </div>

          <div class="text-right mb-4">
            <p class="text-lg font-semibold text-orange-600">Total: $${Number(c.total || 0).toLocaleString("es-CO")}</p>
            ${c.mostrarValorLetras ? `<p class="text-sm italic mt-1">Son: ${valorEnLetras}</p>` : ""}
          </div>

          ${c.notas ? `
            <div class="mb-4 p-3 bg-gray-50 rounded">
              <p class="font-semibold">Notas:</p>
              <p>${c.notas}</p>
            </div>
          ` : ""}

          ${(c.anexos && c.anexos.length) ? `
  <div class="mt-6 border rounded-lg overflow-hidden">
    <button
      onclick="
        const cont = this.nextElementSibling;
        cont.classList.toggle('hidden');
        this.querySelector('span').textContent = cont.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
      "
      class="w-full px-4 py-3 bg-gray-100 font-semibold flex justify-between items-center"
    >
      üìé Anexos (${c.anexos.length})
      <span>‚ñº</span>
    </button>

    <div class="p-4 space-y-6 hidden">

      ${c.anexos.map(a => {

        // üìÑ PDF
        if (a.tipo === "application/pdf") {
          return `
            <div class="border rounded p-3">
              <div class="flex justify-between items-center mb-2">
                <p class="font-semibold">üìÑ ${a.nombre}</p>
                <a
                  href="${a.base64}"
                  download="${a.nombre}"
                  class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700"
                >
                  Descargar
                </a>
              </div>
              <iframe
                src="${a.base64}"
                class="w-full h-[400px] max-h-[70vh] border rounded"
              ></iframe>
            </div>
          `;
        }

        // üñºÔ∏è IM√ÅGENES
        if (a.tipo && a.tipo.startsWith("image/")) {
          return `
            <div class="border rounded p-3">
              <div class="flex justify-between items-center mb-2">
                <p class="font-semibold">üñºÔ∏è ${a.nombre}</p>
                <a
                  href="${a.base64}"
                  download="${a.nombre}"
                  class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700"
                >
                  Descargar
                </a>
              </div>
              <img
                src="${a.base64}"
                alt="${a.nombre}"
                class="max-w-full rounded border"
              />
            </div>
          `;
        }

        // üìé OTROS ARCHIVOS
        return `
          <div class="border rounded p-3 flex justify-between items-center">
            <p class="font-semibold">üìé ${a.nombre}</p>
            <a
              href="${a.base64}"
              download="${a.nombre}"
              class="bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700"
            >
              Descargar
            </a>
          </div>
        `;
      }).join("")}

    </div>
  </div>
` : ""}


          ${c.firmaConfirmacion ? `
            <div class="mt-6 p-4 border rounded bg-gray-50">
              <p class="font-semibold text-green-600">‚úÖ Cuenta de cobro confirmada</p>
              <p class="text-sm">Confirmada el: ${new Date(c.fechaConfirmacion?.seconds * 1000 || Date.now()).toLocaleDateString('es-CO')}</p>
              <div class="mt-2">
                <p class="text-sm font-semibold">Firma de confirmaci√≥n:</p>
                <img src="${c.firmaConfirmacion}" alt="Firma" class="max-w-xs mx-auto border rounded mt-2">
              </div>
            </div>
          ` : ""}
        `;

        // Mostrar botones de acci√≥n
        acciones.classList.remove("hidden");
        
        // Si ya est√° confirmada, ocultar bot√≥n de confirmaci√≥n
        if (c.firmaConfirmacion) {
          document.getElementById("confirmar").classList.add("hidden");
        } else {
          // Mostrar modal autom√°ticamente para cuentas pendientes sin firma
          mostrarModalRecomendacion();
        }
        
      } catch (error) {
        console.error("Error cargando cuenta de cobro:", error);
        container.innerHTML = "<p class='text-red-600'>Error al cargar la cuenta de cobro</p>";
      }
    }

    // Guardar confirmaci√≥n con firma
    async function guardarConfirmacionConFirma(firmaData) {
      try {
        document.getElementById("guardar-firma").textContent = "Guardando...";
        document.getElementById("guardar-firma").disabled = true;
        
        await cuentaRef.update({ 
          firmaConfirmacion: firmaData,
          fechaConfirmacion: new Date()
        });
        
        // Actualizar datos locales
        cuentaData.firmaConfirmacion = firmaData;
        cuentaData.fechaConfirmacion = new Date();
        
        // Mostrar confirmaci√≥n
        confirmacionFirma.classList.remove("hidden");
        firmaContainer.classList.add("hidden");
        
        // Mostrar la firma guardada
        document.getElementById("firma-guardada").innerHTML = `
          <img src="${firmaData}" alt="Su firma" class="border rounded mx-auto max-w-full">
          <p class="text-sm mt-2">Firma guardada correctamente</p>
        `;
        
        // Ocultar bot√≥n de confirmaci√≥n
        document.getElementById("confirmar").classList.add("hidden");
        
        // DESCARGAR PDF AUTOM√ÅTICAMENTE despu√©s de guardar la firma
        setTimeout(() => {
          if (cuentaData) {
            generarPDFCuenta(cuentaData, cuentaData.nombreCliente);
          }
        }, 1000);
        
      } catch (error) {
        console.error("Error al guardar firma:", error);
        alert("‚ùå Error al guardar la firma. Por favor, intente nuevamente.");
        
        document.getElementById("guardar-firma").textContent = "Guardar firma";
        document.getElementById("guardar-firma").disabled = false;
      }
    }

    // Descargar PDF manualmente
    descargarPdfBtn.addEventListener("click", () => {
      if (cuentaData) {
        generarPDFCuenta(cuentaData, cuentaData.nombreCliente);
      }
    });

    // Manejar confirmaci√≥n
    document.getElementById("confirmar").addEventListener("click", () => {
      acciones.classList.add("hidden");
      firmaContainer.classList.remove("hidden");
      setTimeout(inicializarFirma, 100);
    });

    // Event listeners del modal
    btnCerrarModal.addEventListener("click", ocultarModalRecomendacion);
    btnEmpezarFirma.addEventListener("click", () => {
      ocultarModalRecomendacion();
      acciones.classList.add("hidden");
      firmaContainer.classList.remove("hidden");
      setTimeout(inicializarFirma, 100);
    });

    // Cerrar modal al hacer clic fuera
    modalRecomendacion.addEventListener("click", (e) => {
      if (e.target === modalRecomendacion) {
        ocultarModalRecomendacion();
      }
    });

    // Cargar la cuenta cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', cargarCuenta);
  </script>
</body>
</html>
