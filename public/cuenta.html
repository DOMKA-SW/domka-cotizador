<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <title>DOMKA - Cuenta de Cobro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    .hidden { display: none; }
    .signature-pad { border: 1px solid #e5e7eb; border-radius: 0.375rem; background: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-6">
  <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-6 md:p-8 mx-2">

    <!-- üîπ Encabezado -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-lg shadow-md mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Cuenta de Cobro</h1>
        <p class="text-sm">DOMKA | Alex Otalora</p>
      </div>
      <img src="../img/logo.png" alt="DOMKA Logo" class="h-12">
    </div>

    <!-- üîπ Contenido -->
    <div id="cuenta" class="text-gray-800">
      <p>Cargando cuenta de cobro...</p>
    </div>

    <!-- üîπ Firma digital -->
    <div id="firma-container" class="hidden mt-6">
      <h3 class="font-semibold mb-2">Firma de conformidad</h3>
      <p class="text-sm text-gray-600 mb-3">Por favor, firme en el recuadro para confirmar la recepci√≥n</p>
      <canvas id="firma-pad" class="signature-pad w-full" width="500" height="200"></canvas>
      <div class="flex justify-between mt-2">
        <button id="limpiar-firma" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border rounded">Limpiar</button>
        <button id="guardar-firma" class="bg-orange-600 text-white px-4 py-1 rounded text-sm hover:bg-orange-700">Guardar firma</button>
      </div>
    </div>

    <!-- üîπ Botones acci√≥n -->
    <div id="acciones" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-6">
      <button id="confirmar" class="flex items-center gap-2 bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700 mb-2 sm:mb-0">‚úÖ Confirmar Recepci√≥n</button>
      <button id="descargar-pdf" class="flex items-center gap-2 bg-orange-600 text-white px-6 py-2 rounded-lg shadow hover:bg-orange-700">üìÑ Descargar PDF</button>
    </div>

    <!-- üîπ Confirmaci√≥n -->
    <div id="confirmacion-firma" class="hidden mt-6 text-center">
      <p class="text-green-600 font-semibold">‚úÖ Cuenta de cobro confirmada con firma digital</p>
      <p class="text-sm text-gray-600 mt-2">Hemos registrado su confirmaci√≥n correctamente.</p>
      <div id="firma-guardada" class="mt-4 mx-auto max-w-xs"></div>
    </div>

    <!-- üîπ Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
      <p>DOMKA 2025 - Alex Otalora</p>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="../js/firebase.js"></script>
  <script src="../js/numero-letras.js"></script>
  <script src="../js/pdf-cuenta.js"></script>
  <script>
    
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cuenta");
    const acciones = document.getElementById("acciones");
    const firmaContainer = document.getElementById("firma-container");
    const confirmacionFirma = document.getElementById("confirmacion-firma");
    const descargarPdfBtn = document.getElementById("descargar-pdf");

    let cuentaRef;
    let signaturePad;
    let cuentaData = null;

    // Inicializar el pad de firma
    function inicializarFirma() {
      const canvas = document.getElementById("firma-pad");
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1.5,
        maxWidth: 2.5,
        throttle: 16,
      });

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      document.getElementById("limpiar-firma").addEventListener("click", () => {
        signaturePad.clear();
      });

      document.getElementById("guardar-firma").addEventListener("click", () => {
        if (signaturePad.isEmpty()) {
          alert("Por favor, proporcione su firma primero");
          return;
        }

        const firmaData = signaturePad.toDataURL();
        guardarConfirmacionConFirma(firmaData);
      });
    }

    // Cargar cuenta de cobro
    async function cargarCuenta() {
      if (!id) {
        container.innerHTML = "<p class='text-red-600'>Error: No se especific√≥ ID de cuenta de cobro</p>";
        return;
      }

      try {
        cuentaRef = db.collection("cuentas").doc(id);
        const doc = await cuentaRef.get();
        
        if (!doc.exists) {
          container.innerHTML = "<p class='text-red-600'>Error: Cuenta de cobro no encontrada</p>";
          return;
        }

        cuentaData = doc.data();
        cuentaData.id = id; // Asegurar que el ID est√© incluido
        const c = cuentaData;
        const fecha = c.fecha ? new Date(c.fecha.seconds ? c.fecha.seconds * 1000 : c.fecha) : new Date();
        
        const valorEnLetras = (typeof numeroAPalabras === 'function') ? 
          numeroAPalabras(c.total || 0) : 
          `$${Number(c.total || 0).toLocaleString("es-CO")}`;
        
        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <p class="font-semibold">Cliente:</p>
              <p>${c.nombreCliente || "No especificado"}</p>
              <p class="text-sm text-gray-600 mt-1">ID: ${id}</p>
            </div>
            <div class="md:text-right">
              <p class="font-semibold">Fecha:</p>
              <p>${fecha.toLocaleDateString('es-CO')}</p>
              <span class="inline-block mt-2 px-2 py-1 rounded text-xs ${c.estado === "pagada" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}">
                ${c.estado || "pendiente"}
              </span>
            </div>
          </div>

            <!-- üîπ Aqu√≠ agregamos el bloque de "Debe a" y "Por concepto de" -->
          <div class="mb-6">
           <p class="font-semibold">Debe a:</p>
           <p>Alexander Otalora Camayo</p>

           <p class="font-semibold mt-2">Por concepto de:</p>
           <p>${c.concepto || "-"}</p>
          </div>

          <h2 class="text-lg font-semibold border-b pb-2 mb-4">Descripci√≥n del Servicio</h2>
          <div class="mb-6">
            ${(c.items || []).map(item => `
              <div class="border-b py-2">
                <p>${item.descripcion || ""}</p>
              </div>
            `).join("")}
          </div>

          <div class="text-right mb-4">
            <p class="text-lg font-semibold text-orange-600">Total: $${Number(c.total || 0).toLocaleString("es-CO")}</p>
            ${c.mostrarValorLetras ? `<p class="text-sm italic mt-1">Son: ${valorEnLetras}</p>` : ""}
          </div>

          ${c.notas ? `
            <div class="mb-4 p-3 bg-gray-50 rounded">
              <p class="font-semibold">Notas:</p>
              <p>${c.notas}</p>
            </div>
          ` : ""}

          ${c.firmaConfirmacion ? `
            <div class="mt-6 p-4 border rounded bg-gray-50">
              <p class="font-semibold text-green-600">‚úÖ Cuenta de cobro confirmada</p>
              <p class="text-sm">Confirmada el: ${new Date(c.fechaConfirmacion?.seconds * 1000 || Date.now()).toLocaleDateString('es-CO')}</p>
              <div class="mt-2">
                <p class="text-sm font-semibold">Firma de confirmaci√≥n:</p>
                <img src="${c.firmaConfirmacion}" alt="Firma" class="max-w-xs mx-auto border rounded mt-2">
              </div>
            </div>
          ` : ""}
        `;

        // Mostrar botones de acci√≥n
        acciones.classList.remove("hidden");
        
        // Si ya est√° confirmada, ocultar bot√≥n de confirmaci√≥n
        if (c.firmaConfirmacion) {
          document.getElementById("confirmar").classList.add("hidden");
        }
        
      } catch (error) {
        console.error("Error cargando cuenta de cobro:", error);
        container.innerHTML = "<p class='text-red-600'>Error al cargar la cuenta de cobro</p>";
      }
    }

    // Guardar confirmaci√≥n con firma
    async function guardarConfirmacionConFirma(firmaData) {
      try {
        document.getElementById("guardar-firma").textContent = "Guardando...";
        document.getElementById("guardar-firma").disabled = true;
        
        await cuentaRef.update({ 
          firmaConfirmacion: firmaData,
          fechaConfirmacion: new Date()
        });
        
        // Actualizar datos locales
        cuentaData.firmaConfirmacion = firmaData;
        cuentaData.fechaConfirmacion = new Date();
        
        // Mostrar confirmaci√≥n
        confirmacionFirma.classList.remove("hidden");
        firmaContainer.classList.add("hidden");
        
        // Mostrar la firma guardada
        document.getElementById("firma-guardada").innerHTML = `
          <img src="${firmaData}" alt="Su firma" class="border rounded mx-auto max-w-full">
          <p class="text-sm mt-2">Firma guardada correctamente</p>
        `;
        
        // Ocultar bot√≥n de confirmaci√≥n
        document.getElementById("confirmar").classList.add("hidden");
        
        // DESCARGAR PDF AUTOM√ÅTICAMENTE despu√©s de guardar la firma
        setTimeout(() => {
          if (cuentaData) {
            generarPDFCuenta(cuentaData, cuentaData.nombreCliente);
          }
        }, 1000);
        
      } catch (error) {
        console.error("Error al guardar firma:", error);
        alert("‚ùå Error al guardar la firma. Por favor, intente nuevamente.");
        
        document.getElementById("guardar-firma").textContent = "Guardar firma";
        document.getElementById("guardar-firma").disabled = false;
      }
    }

    // Descargar PDF manualmente
    descargarPdfBtn.addEventListener("click", () => {
      if (cuentaData) {
        generarPDFCuenta(cuentaData, cuentaData.nombreCliente);
      }
    });

    // Manejar confirmaci√≥n
    document.getElementById("confirmar").addEventListener("click", () => {
      acciones.classList.add("hidden");
      firmaContainer.classList.remove("hidden");
      setTimeout(inicializarFirma, 100);
    });

    // Cargar la cuenta cuando la p√°gina est√© lista
    document.addEventListener('DOMContentLoaded', cargarCuenta);
  </script>
</body>
</html>
