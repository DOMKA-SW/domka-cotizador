<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <title>DOMKA - Cuenta</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- PDFMake -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>.hidden{display:none;}</style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center py-6">
  <div class="max-w-4xl w-full bg-white shadow-lg rounded-lg p-6 md:p-8 mx-2">

    <!-- Encabezado -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-lg shadow-md mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Cuenta</h1>
        <p class="text-sm">DOMKA | Alex Otalora</p>
      </div>
      <img src="../img/logo.png" alt="DOMKA Logo" class="h-12">
    </div>

    <!-- Contenedor cuenta -->
    <div id="cuenta" class="text-gray-800">
      <p>Cargando cuenta...</p>
    </div>

    <!-- Estado -->
    <div id="estado-cuenta" class="mt-4 text-center"></div>

    <!-- Bot√≥n de descarga PDF -->
    <div class="text-center mt-4">
      <button id="descargar-pdf-publico" class="flex items-center justify-center gap-2 bg-orange-600 text-white px-5 py-2 rounded-lg hover:bg-orange-700 shadow">
        üì• Descargar PDF
      </button>
    </div>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
      <p>DOMKA 2025</p>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script src="../js/firebase.js"></script>
  <script src="../js/numero-letras.js"></script>
  <script src="../js/pdf-cuenta.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cuenta");
    const estadoDiv = document.getElementById("estado-cuenta");
    const btnDescargaPublico = document.getElementById("descargar-pdf-publico");
    let cuentaRef, cuentaData;

    function traducirTipo(tipo){
      switch(tipo){
        case "abono": return "Abono";
        case "pago": return "Pago";
        case "saldo": return "Saldo";
        default: return tipo||"No especificado";
      }
    }

    async function cargarCuenta(){
      if(!id){container.innerHTML="<p class='text-red-600'>Error: No se especific√≥ ID</p>";return;}
      cuentaRef=db.collection("cuentas").doc(id);
      const doc=await cuentaRef.get();
      if(!doc.exists){container.innerHTML="<p class='text-red-600'>No encontrada</p>";return;}

      cuentaData=doc.data();
      const c=cuentaData;
      const fecha=c.fecha?new Date(c.fecha.seconds?c.fecha.seconds*1000:c.fecha):new Date();

      container.innerHTML=`
        <!-- Datos principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm"><p class="text-sm text-gray-500">Nombre/Empresa</p><p class="font-semibold text-gray-800">${c.nombreCliente||"‚Äî"}</p></div>
          <div class="p-4 bg-gray-50 border rounded-lg shadow-sm"><p class="text-sm text-gray-500">Fecha</p><p class="font-semibold text-gray-800">${fecha.toLocaleDateString("es-CO")}</p></div>
          ${c.ubicacion?`<div class="p-4 bg-gray-50 border rounded-lg shadow-sm"><p class="text-sm text-gray-500">Ubicaci√≥n</p><p class="font-semibold text-gray-800">${c.ubicacion}</p></div>`:""}
        </div>

        <!-- Tabla -->
        <h2 class="text-lg font-semibold border-b pb-2 mb-4">Detalle de la cuenta</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left border rounded-lg overflow-hidden shadow-md" id="tabla-cuenta-detalle">
            <thead class="bg-orange-600 text-white text-sm uppercase">
              <tr><th class="px-4 py-2">Descripci√≥n</th><th class="px-4 py-2 text-center">Tipo</th><th class="px-4 py-2 text-right">Valor</th></tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
              ${(c.movimientos||[]).map(item=>`
                <tr>
                  <td class="px-4 py-2">${item.descripcion||""}</td>
                  <td class="px-4 py-2 text-center">${traducirTipo(item.tipo)}</td>
                  <td class="px-4 py-2 text-right">$${Number(item.valor||0).toLocaleString("es-CO")}</td>
                </tr>`).join("")}
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg shadow-sm text-right mt-4">
          <p class="text-gray-700">Saldo: <span class="font-semibold">$${Number(c.saldo||0).toLocaleString("es-CO")}</span></p>
        </div>
      `;

      // Estado
      if(!c.estado||c.estado==="pendiente"){
        estadoDiv.innerHTML=`<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-700">‚è≥ Pendiente</span>`;
      }else if(c.estado==="pagada"){
        estadoDiv.innerHTML=`<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">‚úÖ Pagada</span>`;
      }else if(c.estado==="vencida"){
        estadoDiv.innerHTML=`<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-700">‚ùå Vencida</span>`;
      }

      btnDescargaPublico.onclick=()=>generarPDFCuenta({...c,id},c.nombreCliente);
    }

    document.addEventListener("DOMContentLoaded",cargarCuenta);
  </script>

  <!-- üëá Nuevo bloque para registrar vistas de cuentas -->
  <script>
    (function() {
      const id = new URLSearchParams(window.location.search).get("id");
      if (!id) return;

      async function fetchIpInfo() {
        try {
          const resp = await fetch("https://ipapi.co/json/");
          if (!resp.ok) throw new Error("ip lookup failed");
          return await resp.json();
        } catch (e) {
          console.warn("IP lookup failed:", e);
          return {};
        }
      }

      async function logView() {
        const ipInfo = await fetchIpInfo();
        const payload = {
          docId: id,
          event: "view-cuenta",
          userAgent: navigator.userAgent || null,
          referer: document.referrer || null,
          pagePath: window.location.pathname + window.location.search,
          ip: ipInfo.ip || null,
          city: ipInfo.city || null,
          region: ipInfo.region || null,
          country: ipInfo.country_name || null,
          timezone: ipInfo.timezone || null,
          org: ipInfo.org || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          await db.collection("logs").add(payload);
        } catch (err) {
          console.warn("Error guardando log:", err);
        }
      }

      window.addEventListener("load", logView);
    })();
  </script>
  <!-- üëÜ Fin del bloque nuevo -->

</body>
</html>
