<!DOCTYPE html>
<html lang="es" class="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="../img/favicon.ico" type="image/x-icon">
  <title>DOMKA - Cuenta de Cobro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen py-6">

  <div class="max-w-6xl w-full bg-white shadow-lg rounded-lg p-6 md:p-10 mx-auto">

    <!-- Encabezado -->
    <div class="bg-gradient-to-r from-orange-600 to-orange-400 text-white p-6 rounded-lg shadow-md mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Cuenta de Cobro</h1>
        <p class="text-sm">DOMKA | Alex Otalora</p>
      </div>
      <img src="../img/logo.png" alt="DOMKA Logo" class="h-12">
    </div>

    <!-- Contenido -->
    <div id="cuenta" class="text-gray-800 text-base md:text-[15px] leading-relaxed">
      <p>Cargando cuenta de cobro...</p>
    </div>

    <!-- Estado -->
    <div id="estado-cuenta" class="mt-4 text-center"></div>

    <!-- Bot√≥n descarga PDF -->
    <div class="text-center mt-4">
      <button id="descargar-pdf"
        class="inline-flex items-center justify-center gap-2 bg-orange-600 text-white px-5 py-2 rounded-lg hover:bg-orange-700 shadow">
        üì• Descargar PDF
      </button>
    </div>

    <!-- üîπ Bot√≥n CONFIRMAR RECIBIDO -->
    <div id="acciones" class="hidden mt-6 text-center">
      <p class="text-gray-600 text-sm mb-3">¬øRecibiste esta cuenta de cobro? Conf√≠rmalo con un clic.</p>
      <button id="btn-confirmar-recibido"
        class="inline-flex items-center gap-2 bg-green-600 text-white px-8 py-3 rounded-lg shadow hover:bg-green-700 text-lg font-semibold transition-all">
        ‚úÖ Confirmar Recibido
      </button>
    </div>

    <!-- Confirmaci√≥n exitosa -->
    <div id="confirmacion-recibido" class="hidden mt-6 text-center p-4 bg-green-50 border border-green-200 rounded-lg">
      <p class="text-green-700 font-semibold text-lg">‚úÖ ¬°Recibido confirmado!</p>
      <p class="text-sm text-gray-600 mt-1">Hemos registrado tu confirmaci√≥n correctamente.</p>
    </div>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500 border-t pt-4">
      <p>DOMKA 2025 - Alex Otalora</p>
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="../js/firebase.js"></script>
  <script src="../js/numero-letras.js"></script>
  <script src="../js/pdf-cuenta.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cuenta");
    const acciones = document.getElementById("acciones");
    const estadoDiv = document.getElementById("estado-cuenta");
    const descargarPdfBtn = document.getElementById("descargar-pdf");
    const btnConfirmar = document.getElementById("btn-confirmar-recibido");
    const confirmacionRecibido = document.getElementById("confirmacion-recibido");

    let cuentaRef;
    let cuentaData = null;

    // ============================
    // üîπ Cargar cuenta de cobro
    // ============================
    async function cargarCuenta() {
      if (!id) {
        container.innerHTML = "<p class='text-red-600'>Error: No se especific√≥ ID</p>";
        return;
      }

      try {
        cuentaRef = db.collection("cuentas").doc(id);
        const doc = await cuentaRef.get();
        
        if (!doc.exists) {
          container.innerHTML = "<p class='text-red-600'>Cuenta de cobro no encontrada</p>";
          return;
        }

        cuentaData = doc.data();
        cuentaData.id = id;
        const c = cuentaData;
        const fecha = c.fecha ? new Date(c.fecha.seconds ? c.fecha.seconds * 1000 : c.fecha) : new Date();
        
        const valorEnLetras = (typeof numeroAPalabras === 'function') ? 
          numeroAPalabras(c.total || 0) : 
          `$${Number(c.total || 0).toLocaleString("es-CO")}`;

        // üîπ Notas con vi√±etas
        let notasHTML = "";
        const vi√±etas = c.notasArray && c.notasArray.length > 0
          ? c.notasArray
          : (c.notas ? c.notas.split("\n").filter(l => l.trim()) : []);

        if (vi√±etas.length > 1) {
          notasHTML = `<ul class="list-disc list-inside space-y-1 text-sm text-gray-800">
            ${vi√±etas.map(v => `<li>${v}</li>`).join("")}
          </ul>`;
        } else if (c.notas) {
          notasHTML = `<p class="text-sm text-gray-800">${c.notas}</p>`;
        }
        
        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
              <p class="text-sm text-gray-500">Nombre/Empresa</p>
              <p class="font-semibold">${c.nombreCliente || "No especificado"}</p>
              <p class="text-xs text-gray-400 mt-1">ID: ${id}</p>
            </div>
            <div class="p-4 bg-gray-50 border rounded-lg shadow-sm md:text-right">
              <p class="text-sm text-gray-500">Fecha</p>
              <p class="font-semibold">${fecha.toLocaleDateString('es-CO')}</p>
              <span class="inline-block mt-2 px-2 py-1 rounded text-xs ${c.estado === "pagada" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}">
                ${c.estado || "pendiente"}
              </span>
            </div>
            ${c.mostrarDocumento !== false && c.clienteNit ? `
              <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
                <p class="text-sm text-gray-500">NIT</p>
                <p class="font-semibold">${c.clienteNit}</p>
              </div>` : ""}
            ${c.mostrarDocumento !== false && c.clienteNumeroDocumento ? `
              <div class="p-4 bg-gray-50 border rounded-lg shadow-sm">
                <p class="text-sm text-gray-500">N¬∞ Documento</p>
                <p class="font-semibold">${c.clienteNumeroDocumento}</p>
              </div>` : ""}
          </div>

          <!-- Debe a / concepto -->
          <div class="mb-6 p-4 bg-gray-50 border rounded-lg shadow-sm">
            <p class="font-semibold">Debe a:</p>
            <p>Alexander Otalora Camayo</p>
            <p class="font-semibold mt-2">Por concepto de:</p>
            <p>${c.concepto || "-"}</p>
          </div>

          <h2 class="text-lg font-semibold border-b pb-2 mb-4">Descripci√≥n del Servicio</h2>
          <div class="mb-6">
            ${(c.items || []).map(item => `
              <div class="border-b py-2">
                <p>${item.descripcion || ""}</p>
              </div>
            `).join("")}
          </div>

          <div class="text-right mb-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
            <p class="text-lg font-semibold text-orange-600">Total: $${Number(c.total || 0).toLocaleString("es-CO")}</p>
            ${c.mostrarValorLetras ? `<p class="text-sm italic mt-1">Son: ${valorEnLetras}</p>` : ""}
          </div>

          ${notasHTML ? `
            <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
              <p class="font-semibold mb-2">Notas:</p>
              ${notasHTML}
            </div>` : ""}

          <!-- Anexos -->
          ${(c.anexos && c.anexos.length) ? `
            <div class="mt-6 border rounded-lg overflow-hidden">
              <button onclick="
                const cont = this.nextElementSibling;
                cont.classList.toggle('hidden');
                this.querySelector('span').textContent = cont.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
              " class="w-full px-4 py-3 bg-gray-100 font-semibold flex justify-between items-center">
                üìé Anexos (${c.anexos.length})
                <span>‚ñº</span>
              </button>
              <div class="p-4 space-y-6 hidden">
                ${c.anexos.map(a => {
                  if (a.tipo === "application/pdf") {
                    return `<div class="border rounded p-3">
                      <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold">üìÑ ${a.nombre}</p>
                        <a href="${a.base64}" download="${a.nombre}" class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                      </div>
                      <iframe src="${a.base64}" class="w-full h-[400px] max-h-[70vh] border rounded"></iframe>
                    </div>`;
                  }
                  if (a.tipo && a.tipo.startsWith("image/")) {
                    return `<div class="border rounded p-3">
                      <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold">üñºÔ∏è ${a.nombre}</p>
                        <a href="${a.base64}" download="${a.nombre}" class="text-sm bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                      </div>
                      <img src="${a.base64}" alt="${a.nombre}" class="max-w-full rounded border"/>
                    </div>`;
                  }
                  return `<div class="border rounded p-3 flex justify-between items-center">
                    <p class="font-semibold">üìé ${a.nombre}</p>
                    <a href="${a.base64}" download="${a.nombre}" class="bg-orange-600 text-white px-3 py-1 rounded hover:bg-orange-700">Descargar</a>
                  </div>`;
                }).join("")}
              </div>
            </div>` : ""}
        `;

        // Mostrar estado y bot√≥n
        if (!c.recibidoConfirmado) {
          estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-700">‚è≥ Pendiente de confirmaci√≥n</span>`;
          acciones.classList.remove("hidden");
        } else {
          estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">‚úÖ Recibido confirmado</span>`;
        }

      } catch (error) {
        console.error("Error cargando cuenta:", error);
        container.innerHTML = "<p class='text-red-600'>Error al cargar la cuenta de cobro</p>";
      }
    }

    // ============================
    // üîπ Confirmar Recibido ‚Äî solo log, sin firma
    // ============================
    btnConfirmar.addEventListener("click", async () => {
      btnConfirmar.disabled = true;
      btnConfirmar.textContent = "Guardando...";

      try {
        await cuentaRef.update({
          recibidoConfirmado: true,
          fechaRecibido: firebase.firestore.FieldValue.serverTimestamp()
        });

        // üîπ Guardar log
        await db.collection("logs").add({
          docId: id,
          tipo: "cuenta",
          accion: "recibido_confirmado",
          nombreCliente: cuentaData?.nombreCliente || "",
          total: cuentaData?.total || 0,
          userAgent: navigator.userAgent || null,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        acciones.classList.add("hidden");
        confirmacionRecibido.classList.remove("hidden");
        estadoDiv.innerHTML = `<span class="inline-block px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-700">‚úÖ Recibido confirmado</span>`;
      } catch (e) {
        console.error("Error al confirmar:", e);
        btnConfirmar.disabled = false;
        btnConfirmar.textContent = "‚úÖ Confirmar Recibido";
        alert("Error al confirmar. Por favor intenta de nuevo.");
      }
    });

    // Descargar PDF
    descargarPdfBtn.addEventListener("click", () => {
      if (cuentaData) generarPDFCuenta(cuentaData, cuentaData.nombreCliente);
    });

    // ============================
    // üîπ Tracking de visitas
    // ============================
    (function() {
      async function fetchIpInfo() {
        try {
          const resp = await fetch("https://ipapi.co/json/");
          if (!resp.ok) throw new Error("ip lookup failed");
          return await resp.json();
        } catch (e) {
          return {};
        }
      }

      async function logView() {
        const ipInfo = await fetchIpInfo();
        try {
          await db.collection("logs").add({
            docId: id,
            tipo: "cuenta",
            accion: "vista",
            userAgent: navigator.userAgent || null,
            referer: document.referrer || null,
            ip: ipInfo.ip || null,
            city: ipInfo.city || null,
            country: ipInfo.country_name || null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (err) {
          console.warn("Error guardando log:", err);
        }
      }

      window.addEventListener("load", logView);
    })();

    document.addEventListener('DOMContentLoaded', cargarCuenta);
  </script>
</body>
</html>
