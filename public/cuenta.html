<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>DOMKA - Cuenta de Cobro (Vista pública)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <style>
    .hidden { display: none; }
    .signature-pad {
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center py-4">
  <div class="max-w-3xl w-full bg-white shadow-lg rounded-lg p-4 md:p-6 mx-2">
    <h1 class="text-2xl font-bold text-orange-600 mb-4 text-center">Cuenta de Cobro DOMKA</h1>
    <div id="cuenta" class="text-gray-800">
      <p>Cargando cuenta de cobro...</p>
    </div>
    
    <!-- Firma digital -->
    <div id="firma-container" class="hidden mt-6">
      <h3 class="font-semibold mb-2">Firma de conformidad</h3>
      <p class="text-sm text-gray-600 mb-3">Por favor, firme en el recuadro para confirmar la recepción de esta cuenta de cobro</p>
      <canvas id="firma-pad" class="signature-pad w-full" width="500" height="200"></canvas>
      <div class="flex justify-between mt-2">
        <button id="limpiar-firma" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border rounded">Limpiar firma</button>
        <button id="guardar-firma" class="bg-orange-600 text-white px-4 py-1 rounded text-sm hover:bg-orange-700">Guardar firma</button>
      </div>
    </div>

    <!-- Botones acción -->
    <div id="acciones" class="hidden flex flex-col sm:flex-row justify-center gap-4 mt-6">
      <button id="confirmar" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 mb-2 sm:mb-0">✅ Confirmar Recepción</button>
    </div>

    <!-- Confirmación con firma -->
    <div id="confirmacion-firma" class="hidden mt-6 text-center">
      <p class="text-green-600 font-semibold">✅ Cuenta de cobro confirmada con firma digital</p>
      <p class="text-sm text-gray-600 mt-2">Hemos registrado su confirmación correctamente.</p>
      <div id="firma-guardada" class="mt-4 mx-auto max-w-xs"></div>
      <button id="descargar-pdf" class="mt-4 bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">Descargar PDF</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Configuración Firebase -->
  <script src="../js/firebase.js"></script>
  
  <!-- Conversor de números a letras -->
  <script src="../js/numero-letras.js"></script>
  
  <!-- PDF Cuenta de Cobro -->
  <script src="../js/pdf-cuenta.js"></script>
  
  <!-- Script público -->
  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const container = document.getElementById("cuenta");
    const acciones = document.getElementById("acciones");
    const firmaContainer = document.getElementById("firma-container");
    const confirmacionFirma = document.getElementById("confirmacion-firma");

    let cuentaRef;
    let signaturePad;
    let cuentaData = null;

    // Inicializar el pad de firma
    function inicializarFirma() {
      const canvas = document.getElementById("firma-pad");
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgba(255, 255, 255, 0)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1.5,
        maxWidth: 2.5,
        throttle: 16,
      });

      function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
      }

      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      document.getElementById("limpiar-firma").addEventListener("click", () => {
        signaturePad.clear();
      });

      document.getElementById("guardar-firma").addEventListener("click", () => {
        if (signaturePad.isEmpty()) {
          alert("Por favor, proporcione su firma primero");
          return;
        }

        const firmaData = signaturePad.toDataURL();
        guardarConfirmacionConFirma(firmaData);
      });
    }

    // Función para ocultar columnas en modo valor total
    function ocultarColumnasValorTotal() {
      const tabla = document.getElementById("tabla-cuenta-detalle");
      if (!tabla) return;
      
      const headers = tabla.querySelectorAll("th");
      if (headers.length >= 4) {
        headers[1].classList.add("hidden");
        headers[2].classList.add("hidden");
        headers[3].classList.add("hidden");
      }
      
      const cells = tabla.querySelectorAll("td");
      for (let i = 0; i < cells.length; i++) {
        if (cells[i].classList.contains("col-cantidad") || 
            cells[i].classList.contains("col-precio") || 
            cells[i].classList.contains("col-subtotal")) {
          cells[i].classList.add("hidden");
        }
      }
    }

    // Cargar cuenta de cobro
    async function cargarCuenta() {
      if (!id) {
        container.innerHTML = "<p class='text-red-600'>Error: No se especificó ID de cuenta de cobro</p>";
        return;
      }

      try {
        cuentaRef = db.collection("cuentas").doc(id);
        const doc = await cuentaRef.get();
        
        if (!doc.exists) {
          container.innerHTML = "<p class='text-red-600'>Error: Cuenta de cobro no encontrada</p>";
          return;
        }

        cuentaData = doc.data();
        const c = cuentaData;
        const fecha = c.fecha ? new Date(c.fecha.seconds ? c.fecha.seconds * 1000 : c.fecha) : new Date();
        
        const valorEnLetras = (typeof numeroAPalabras === 'function') ? 
          numeroAPalabras(c.total || 0) : 
          `$${Number(c.total || 0).toLocaleString("es-CO")}`;
        
        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <p class="font-semibold">Cliente:</p>
              <p>${c.nombreCliente || "No especificado"}</p>
            </div>
            <div class="md:text-right">
              <p class="font-semibold">Fecha:</p>
              <p>${fecha.toLocaleDateString('es-CO')}</p>
              <span class="inline-block mt-2 px-2 py-1 rounded text-xs ${c.estado === "pagada" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}">
                ${c.estado || "pendiente"}
              </span>
            </div>
          </div>

          <h2 class="text-lg font-semibold border-b pb-2 mb-4">Detalle de la cuenta de cobro</h2>
          <div class="overflow-x-auto">
            <table class="w-full mb-6" id="tabla-cuenta-detalle">
              <thead class="bg-orange-600 text-white">
                <tr>
                  <th class="p-2 text-left">Descripción</th>
                  <th class="p-2 text-center col-cantidad">Cantidad</th>
                  <th class="p-2 text-right col-precio">Precio</th>
                  <th class="p-2 text-right col-subtotal">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${(c.items || []).map(item => `
                  <tr class="border-b">
                    <td class="p-2">${item.descripcion || ""}</td>
                    <td class="p-2 text-center col-cantidad">${item.cantidad || 0}</td>
                    <td class="p-2 text-right col-precio">$${Number(item.precio || 0).toLocaleString("es-CO")}</td>
                    <td class="p-2 text-right col-subtotal">$${Number(item.subtotal || 0).toLocaleString("es-CO")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>

          <div class="text-right mb-4">
            <p>Subtotal: $${Number(c.subtotal || 0).toLocaleString("es-CO")}</p>
            <p class="text-lg font-semibold text-orange-600">Total: $${Number(c.total || 0).toLocaleString("es-CO")}</p>
            ${c.mostrarValorLetras ? `<p class="text-sm italic mt-1">Son: ${valorEnLetras}</p>` : ""}
          </div>

          ${c.notas ? `
            <div class="mb-4 p-3 bg-gray-50 rounded">
              <p class="font-semibold">Notas:</p>
              <p>${c.notas}</p>
            </div>
          ` : ""}

          ${c.terminos ? `
            <div class="mb-4 p-3 bg-gray-50 rounded">
              <p class="font-semibold">Términos y Condiciones:</p>
              <p class="text-sm whitespace-pre-line">${c.terminos}</p>
            </div>
          ` : ""}

          ${c.firmaConfirmacion ? `
            <div class="mt-6 p-4 border rounded bg-gray-50">
              <p class="font-semibold text-green-600">✅ Cuenta de cobro confirmada</p>
              <p class="text-sm">Confirmada el: ${new Date(c.fechaConfirmacion?.seconds * 1000 || Date.now()).toLocaleDateString('es-CO')}</p>
              <div class="mt-2">
                <p class="text-sm font-semibold">Firma de confirmación:</p>
                <img src="${c.firmaConfirmacion}" alt="Firma" class="max-w-xs mx-auto border rounded mt-2">
              </div>
            </div>
          ` : ""}
        `;

        // Ocultar columnas si es modo valor total
        if (c.tipoCalculo === "valor-total") {
          setTimeout(ocultarColumnasValorTotal, 100);
        }

        // Mostrar botones de acción solo si no está confirmada
        if (!c.firmaConfirmacion) {
          acciones.classList.remove("hidden");
        }
        
      } catch (error) {
        console.error("Error cargando cuenta de cobro:", error);
        container.innerHTML = "<p class='text-red-600'>Error al cargar la cuenta de cobro</p>";
      }
    }

    // Guardar confirmación con firma
    async function guardarConfirmacionConFirma(firmaData) {
      try {
        document.getElementById("guardar-firma").textContent = "Guardando...";
        document.getElementById("guardar-firma").disabled = true;
        
        await cuentaRef.update({ 
          firmaConfirmacion: firmaData,
          fechaConfirmacion: new Date()
        });
        
        // Actualizar datos locales
        cuentaData.firmaConfirmacion = firmaData;
        cuentaData.fechaConfirmacion = new Date();
        
        // Mostrar confirmación
        confirmacionFirma.classList.remove("hidden");
        firmaContainer.classList.add("hidden");
        acciones.classList.add("hidden");
        
        // Mostrar la firma guardada
        document.getElementById("firma-guardada").innerHTML = `
          <img src="${firmaData}" alt="Su firma" class="border rounded mx-auto max-w-full">
          <p class="text-sm mt-2">Firma guardada correctamente</p>
        `;
        
      } catch (error) {
        console.error("Error al guardar firma:", error);
        alert("❌ Error al guardar la firma. Por favor, intente nuevamente.");
        
        document.getElementById("guardar-firma").textContent = "Guardar firma";
        document.getElementById("guardar-firma").disabled = false;
      }
    }

    // Descargar PDF manualmente
    document.getElementById("descargar-pdf").addEventListener("click", () => {
      if (cuentaData) {
        generarPDFCuenta({...cuentaData, id: id}, cuentaData.nombreCliente);
      }
    });

    // Manejar confirmación
    document.getElementById("confirmar").addEventListener("click", () => {
      acciones.classList.add("hidden");
      firmaContainer.classList.remove("hidden");
      setTimeout(inicializarFirma, 100);
    });

    // Cargar la cuenta cuando la página esté lista
    document.addEventListener('DOMContentLoaded', cargarCuenta);
  </script>
</body>
</html>
