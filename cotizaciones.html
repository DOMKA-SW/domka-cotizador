<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>DOMKA ‚Äî Cotizaciones</title>
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/app-pages.css">
  <style>
    .hidden { display: none !important; }

    /* Totales con dise√±o DOMKA */
    .totales-container {
      background: var(--white);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: 20px 22px;
    }

    .totales-total-row {
      background: var(--text);
      border-radius: 10px;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .totales-total-label {
      font-size: .68rem; font-weight: 700;
      letter-spacing: .14em; text-transform: uppercase;
      color: rgba(255,255,255,.6);
    }

    .totales-total-value {
      font-family: 'DM Serif Display', serif;
      font-size: 1.6rem; color: #fff;
    }

    /* Scrollbar */
    .scrollable-table::-webkit-scrollbar { height: 5px; }
    .scrollable-table::-webkit-scrollbar-thumb { background: var(--green); border-radius: 3px; }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="app-sidebar">
  <div class="sidebar-brand-wrap">
    <span class="sidebar-brand-name">DOMKA</span>
    <span class="sidebar-brand-sub">Construcci√≥n &amp; Dise√±o</span>
  </div>
  <nav class="sidebar-links">
    <a href="dashboard.html" class="sidebar-link"><i class="fas fa-home"></i> Dashboard</a>
    <a href="cotizaciones.html" class="sidebar-link active"><i class="fas fa-file-alt"></i> Cotizaciones</a>
    <a href="cuentas.html" class="sidebar-link"><i class="fas fa-file-invoice-dollar"></i> Cuentas de cobro</a>
    <a href="clientes.html" class="sidebar-link"><i class="fas fa-users"></i> Clientes</a>
    <a href="contabilidad.html" class="sidebar-link"><i class="fas fa-chart-bar"></i> Contabilidad</a>
  </nav>
  <div class="sidebar-bottom">
    <div class="user-indicator">
      <div class="user-dot"></div>
      <span class="user-email-text" id="user-email">Cargando‚Ä¶</span>
    </div>
    <button onclick="logout()" class="btn-logout">
      <i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n
    </button>
  </div>
</aside>

<!-- MAIN -->
<div class="page-with-sidebar">

  <!-- TOP BAR -->
  <div class="page-topbar">
    <div>
      <h1 class="page-heading">Cotizaciones</h1>
      <p class="page-subheading">Crea y gestiona tus cotizaciones</p>
    </div>
    <a href="dashboard.html" class="btn-secondary px-4 py-2 rounded-lg inline-flex items-center gap-2 text-sm">
      <i class="fas fa-arrow-left"></i> Volver al Dashboard
    </a>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Formulario Cotizaci√≥n -->
    <div class="lg:col-span-2">
      <div class="form-container p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6 pb-3 border-b border-gray-200">
          Nueva Cotizaci√≥n
        </h2>

        <form id="form-cotizacion" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="form-label">Cliente</label>
              <select id="cliente" class="form-input" required>
                <option value="">‚Äî Selecciona un cliente ‚Äî</option>
              </select>
            </div>
            <div>
              <label class="form-label">Ubicaci√≥n</label>
              <input type="text" id="ubicacion" class="form-input" placeholder="Ej: Bogot√°, Calle 123 #45-67">
            </div>
          </div>

          <!-- Notas -->
          <div>
            <label class="form-label">Notas</label>
            <div class="flex gap-2 mb-3">
              <button type="button" id="btn-notas-libre" class="px-3 py-1.5 rounded text-sm">üìù Texto libre</button>
              <button type="button" id="btn-notas-vinetas" class="px-3 py-1.5 rounded text-sm">‚Ä¢ Vi√±etas</button>
            </div>
            <div id="notas-modo-libre">
              <textarea id="notas" rows="3" spellcheck="true" lang="es" class="form-input" placeholder="Notas adicionales... (cada l√≠nea ser√° una vi√±eta en el PDF)"></textarea>
            </div>
            <div id="notas-modo-vinetas" class="hidden">
              <div id="notas-vinetas-container"></div>
              <button type="button" id="agregar-vineta" class="mt-2 text-sm" style="color:var(--green)">+ Agregar vi√±eta</button>
            </div>
          </div>

          <!-- Mostrar documento -->
          <div class="p-3 rounded-lg" style="background:var(--bg-alt);border:1px solid var(--line)">
            <label class="flex items-center gap-2" style="font-size:.88rem">
              <input type="checkbox" id="mostrar-documento" checked style="accent-color:var(--green)">
              Mostrar n√∫mero de documento en el PDF
            </label>
          </div>

          <!-- Anexos -->
          <div>
            <div class="flex justify-between items-center px-4 py-3 rounded-lg cursor-pointer" style="background:var(--bg-alt);border:1px solid var(--line)" id="toggle-anexos">
              <span class="font-semibold text-sm flex items-center gap-2" style="color:var(--text)">
                <i class="fas fa-paperclip" style="color:var(--green)"></i> Anexos
              </span>
              <span id="icon-anexos" style="color:var(--gray)">+</span>
            </div>
            <div id="seccion-anexos" class="hidden mt-2 p-4 rounded-lg" style="background:var(--bg-alt);border:1px solid var(--line)">
              <input type="file" id="anexos-input" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,image/*" class="w-full border rounded p-2 mb-2" style="border-color:var(--line)">
              <p class="text-xs" style="color:var(--gray-lt)">M√°x. 500 KB por archivo ¬∑ PDF, Word, PPT o im√°genes</p>
              <ul id="lista-anexos" class="mt-3 space-y-2"></ul>
            </div>
          </div>

          <!-- Tipo de cotizaci√≥n -->
          <div>
            <label class="form-label mb-2">Tipo de Cotizaci√≥n</label>
            <div class="radio-group flex gap-3 flex-wrap">
              <label class="radio-option flex items-center gap-2 px-4 py-2 cursor-pointer" style="border:1.5px solid var(--line);border-radius:8px;background:var(--white)">
                <input type="radio" name="tipo" value="mano-obra" checked style="accent-color:var(--green)"> Mano de obra
              </label>
              <label class="radio-option flex items-center gap-2 px-4 py-2 cursor-pointer" style="border:1.5px solid var(--line);border-radius:8px;background:var(--white)">
                <input type="radio" name="tipo" value="materiales" style="accent-color:var(--green)"> Materiales
              </label>
              <label class="radio-option flex items-center gap-2 px-4 py-2 cursor-pointer" style="border:1.5px solid var(--line);border-radius:8px;background:var(--white)">
                <input type="radio" name="tipo" value="ambos" style="accent-color:var(--green)"> Ambos
              </label>
            </div>
          </div>

          <!-- Forma de pago -->
          <div>
            <label class="form-label">Forma de Pago</label>
            <select id="forma-pago" class="form-input mb-3">
              <option value="contado">Pago al contado</option>
              <option value="60-40">60% al inicio - 40% al finalizar</option>
              <option value="50-50">50% al inicio - 50% al finalizar</option>
              <option value="tres-pagos">Tres pagos (40%-30%-30%)</option>
              <option value="personalizado">Personalizado...</option>
            </select>
            <div id="pagos-personalizados" class="hidden mt-4 p-4 rounded-lg" style="background:var(--green-lt);border:1px solid rgba(27,122,81,.2)">
              <div class="grid grid-cols-3 gap-3 mb-2">
                <div><label class="form-label">Pago 1 (%)</label><input type="number" id="pago1" class="form-input" value="50"></div>
                <div><label class="form-label">Pago 2 (%)</label><input type="number" id="pago2" class="form-input" value="50"></div>
                <div><label class="form-label">Pago 3 (%)</label><input type="number" id="pago3" class="form-input" value="0"></div>
              </div>
              <p class="text-xs" style="color:var(--green)">La suma debe ser 100%</p>
            </div>
          </div>

          <!-- Tipo de c√°lculo -->
          <div>
            <label class="form-label mb-2">Tipo de c√°lculo</label>
            <div class="flex gap-3 flex-wrap">
              <label class="radio-option flex items-center gap-2 px-4 py-2 cursor-pointer" style="border:1.5px solid var(--line);border-radius:8px;background:var(--white)">
                <input type="radio" name="tipo-calculo" value="por-items" checked style="accent-color:var(--green)"> Calcular por √≠tems
              </label>
              <label class="radio-option flex items-center gap-2 px-4 py-2 cursor-pointer" style="border:1.5px solid var(--line);border-radius:8px;background:var(--white)">
                <input type="radio" name="tipo-calculo" value="valor-total" style="accent-color:var(--green)"> Ingresar valor total
              </label>
            </div>
          </div>

          <div id="campo-valor-total" class="hidden">
            <label class="form-label">Valor total</label>
            <input type="number" id="valor-total" class="form-input" value="0" min="0">
          </div>

          <!-- Mostrar letras -->
          <div class="p-3 rounded-lg" style="background:var(--bg-alt);border:1px solid var(--line)">
            <label class="flex items-center gap-2" style="font-size:.88rem">
              <input type="checkbox" id="mostrar-valor-letras" checked style="accent-color:var(--green)">
              Mostrar valor total en letras en el PDF
            </label>
          </div>

          <!-- Tabla √≠tems -->
          <div>
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold" style="color:var(--text)">√çtems</h3>
              <button type="button" id="agregar-item" class="btn-primary px-3 py-2 rounded-lg text-sm">
                + Agregar √çtem
              </button>
            </div>
            <div class="scrollable-table" style="border-radius:10px;overflow:hidden;border:1px solid var(--line)">
              <table class="w-full border-collapse" id="tabla-items">
                <thead>
                  <tr>
                    <th class="p-3 text-left">Descripci√≥n</th>
                    <th class="p-3 text-center col-cantidad">Cantidad</th>
                    <th class="p-3 text-right col-precio">Precio</th>
                    <th class="p-3 text-right col-subtotal">Subtotal</th>
                    <th class="p-3 text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Totales -->
          <div class="totales-container">
            <div class="flex justify-between items-center mb-2">
              <span style="color:var(--gray);font-size:.9rem">Subtotal:</span>
              <span class="font-semibold" id="subtotal">$0</span>
            </div>
            <div class="totales-total-row">
              <span class="totales-total-label">Total a pagar</span>
              <span class="totales-total-value" id="total">$0</span>
            </div>
            <p id="valor-letras" class="text-sm mt-2 italic" style="color:var(--gray-lt);text-align:right">Cero pesos</p>
          </div>

          <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-base w-full mt-2">
            Guardar Cotizaci√≥n
          </button>
        </form>
      </div>
    </div>

    <!-- Lista cotizaciones -->
    <div>
      <div class="form-container p-5">
        <h2 class="text-xl mb-5 pb-3" style="border-bottom:1px solid var(--line)">
          Cotizaciones Guardadas
        </h2>
        <div class="scrollable-table">
          <table class="w-full border-collapse" id="tabla-cotizaciones">
            <thead>
              <tr>
                <th class="p-3 text-left">Cliente</th>
                <th class="p-3 text-left">Total</th>
                <th class="p-3 text-left">Tipo</th>
                <th class="p-3 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="js/firebase.js"></script>
<script src="js/auth.js"></script>
<script src="js/numero-letras.js"></script>
<script src="js/pdf-cotizacion.js"></script>
<script src="js/cotizaciones.js"></script>
<script>
  if (typeof auth !== 'undefined') {
    auth.onAuthStateChanged && auth.onAuthStateChanged(u => {
      const el = document.getElementById('user-email');
      if (el) el.textContent = u?.email || 'Usuario';
    });
  }
  function logout() {
    if (typeof auth !== 'undefined') auth.signOut().then(() => window.location.href = 'index.html');
  }
</script>
</body>
</html>
